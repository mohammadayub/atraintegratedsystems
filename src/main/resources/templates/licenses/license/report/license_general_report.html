<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">

<head th:replace="~{layout :: page_head}">
    <meta charset="UTF-8">
    <div th:replace="styles :: data-tables-styles"></div>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <title>LMS - Report</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">

    <div th:replace="styles :: data-tables-styles"></div>
    <div th:replace="styles :: select2-styles"></div>
    <div th:replace="styles :: commonfieldset-with-legend-border"></div>

    <style>
        /* Custom styles for small font and nice border */
        .table-sm th, .table-sm td {
            font-size: 0.6em; /* Smaller font size */
            padding: 0.3rem; /* Adjusted padding for a compact look */
        }
        .table-bordered th, .table-bordered td {
            border: 1px solid #dee2e6; /* Light border color */
            text-align:center;
        }
        .table-bordered {
            border-collapse: collapse;
        }

        #licenseTypeCount {
    height: 50vh; /* Or any desired height */
}
    </style>
</head>

<body>
<nav th:replace="~{layout :: page_navbar}"></nav>

<div class="container-fluid">
    <h3 class="my-3 text-center text-primary" th:text="#{general_report_heading}">General Report of the License</h3>
    <div class="table-container table-responsive">
        <table class="table table-sm table-bordered" id="profileTable">
            <thead class="text-center">
            <tr>
                <th th:text="#{id}"></th>
                <th th:text="#{applicant_request_id}"></th>
                <th th:text="#{applicant_license_type}"></th>
                <th th:text="#{license_application_company_license_name}"></th>
                <th th:text="#{profile_entered_by}">Profile Entered By</th>
                <th th:text="#{profile_entered_date}">Profile Entered Created Date</th>
                <th th:text="#{license_application_fee}"></th>
                <th th:text="#{applicant_payment_status}">Payment Status</th>
                <th th:text="#{approval_license_date}"></th>
                <th th:text="#{license_fee_entered_by}">License Fees Entered By</th>
                <th th:text="#{license_fee_created_date}">License Fees Created Date</th>
                <th th:text="#{license_approval_license_fees}"></th>
                <th th:text="#{licenses_fee_payment_status}">License Fees Status</th>
                <th th:text="#{administration_fee_entered_by}">Administration Fee Entered By</th>
                <th th:text="#{administration_fee_created_date}">Administration Fee Created Date</th>
                <th th:text="#{license_approval_admin_yearly_fees}"></th>
                <th th:text="#{administration_fee_payment_status}">Administration Fee Payment Status</th>
                <th th:text="#{database_fee_entered_by}">Database Fees Entered By</th>
                <th th:text="#{database_fee_created_date}">Database Fees Created Date</th>
                <th th:text="#{license_approval_database_yearly_maintenance_fees}"></th>
                <th th:text="#{database_fee_paymente_status}">Database Fees Payment Status</th>
                <th th:text="#{guarantee_fee_entered_by}">Guarantee Fees Entered By</th>
                <th th:text="#{guarantee_fee_created_date}">Guarantee Fees Created Date</th>
                <th th:text="#{license_approval_guarantee_fees}"></th>
                <th th:text="#{guarantee_fee_payment_status}">Guarantee Fees Payment Status</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="profile : ${profiles}">
                <td th:text="${profile.licenseApplicant.id}"></td>
                <td th:text="${profile.licenseApplicant.reqId}"></td>
                <td th:text="${profile.licenseType.name}"></td>
                <td th:text="${profile.licenseApplicant.companyLicenseName}"></td>
                <td th:text="${profile.licenseApplicant.profileEnteredBy}"></td>
                <td th:text="${profile.licenseApplicant.profileEnteredCreatedDate}"></td>
                <td th:text="${profile.licenseApplicant.applicationFees}" style="background-color:#FCEFCB"></td>
                <td th:text="${profile.licenseApplicant.paymentStatus}"></td>
                <td th:text="${profile.getAppDate()}"></td>
                <td th:text="${profile.licenseFeesEnteredBy}"></td>
                <td th:text="${profile.licenseFeesCreatedDate}"></td>
                <td th:text="${profile.licenseFees}" style="background-color:#E9A319"></td>
                <td th:text="${profile.licenseFeePaymentStatus}"></td>
                <td th:text="${profile.administrationFeesEnteredBy}"></td>
                <td th:text="${profile.administrationFeesCreatedDate}"></td>
                <td th:text="${profile.administrativeYearlyFees}" style="background-color:#A86523"></td>
                <td th:text="${profile.administrationFeePaymentStatus}"></td>
                <td th:text="${profile.databaseMaintainanceFeesEnteredBy}"></td>
                <td th:text="${profile.databaseMaintainanceFeesCreatedDate}"></td>
                <td th:text="${profile.databaseYearlyMaintainanceFees}" style="background-color:#FF9B17"></td>
                <td th:text="${profile.databaseMaintianenceFeePaymentStatus}"></td>
                <td th:text="${profile.guaranteeFeesEnteredBy}"></td>
                <td th:text="${profile.guaranteeFeesCreatedDate}"></td>
                <td th:text="${profile.guaranteeFees}"  style="background-color:#F16767" ></td>
                <td th:text="${profile.guaranteeFeePaymentStatus}"></td>
            </tr>
            </tbody>
            <tfoot>
            <tr class="grand-total">
                <td class="text-end">Grand Totals:</td>
                <td colspan="5"></td>
                <td id="applicationFeesTotal"></td>
                <td colspan="4"></td>
                <td id="licenseFeesTotal"></td>
                <td colspan="3"></td>
                <td id="adminFeesTotal"></td>
                <td colspan="3"></td>
                <td id="dbFeesTotal"></td>
                <td colspan="3"></td>
                <td id="guaranteeFeesTotal"></td>
                <td></td>
            </tr>
            </tfoot>
        </table>
        <div id="licenseTypeCount" class="d-flex justify-content-center align-items-center">
            <div class="card border-info" style="width: 18rem;">
                <div class="card-header text-center text-white bg-info">
                    <strong>License Types Count</strong>
                </div>
                <div class="card-body">
                    <div id="licenseTypeCountData">
                        <p class="card-text">
                            <strong>Total Number of License Types:</strong> <span id="licenseTypeCountTotal"></span><br>
                        <div id="licenseTypeDetails">
                            <table class="table table-sm table-bordered" id="licenseTypeTable">
                                <thead>
                                <tr>
                                    <th>License Type</th>
                                    <th>Count</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- License Type Details will be dynamically populated here -->
                                </tbody>
                            </table>
                        </div>
                        </p>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <a th:href="@{/licenses/license/report}" class="btn btn-info mt-3 text-white">
        Back to Page
    </a>
</div>

<!-- Scripts -->
<div th:replace="scripts :: common-scripts"></div>
<script th:src="@{/js/reportsJqueryDataTable.js}"></script>
<script th:src="@{/js/reportsDataTableButtons.js}"></script>
<script th:src="@{/js/reportsDataTableButtonsHTML5.js}"></script>
<script th:src="@{/js/jszip.min.js}"></script>
<script>
    $(document).ready(function () {
        const table = $('#profileTable').DataTable({
            scrollX: true,
            dom: 'Bfrtip',
            pageLength: 10,
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: 'Export to Excel',
                    footer: true,
                    exportOptions: {
                        columns: ':visible'
                    },
                    customize: function (xlsx) {
                        let sheet = xlsx.xl.worksheets['sheet1.xml'];
                        $('col', sheet).attr('width', '30');
                    }
                }
            ],
            footerCallback: function (row, data, start, end, display) {
                const api = this.api();

                const intVal = function (i) {
                    return typeof i === 'string'
                        ? parseFloat(i.replace(/[,]/g, '')) || 0
                        : typeof i === 'number'
                            ? i
                            : 0;
                };

                const formatNumber = function (num) {
                    return num.toLocaleString(undefined, {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                };

                let applicationFeesTotal = api.column(6, { search: 'applied' }).data().reduce((a, b) => intVal(a) + intVal(b), 0);
                let licenseFeesTotal = api.column(11, { search: 'applied' }).data().reduce((a, b) => intVal(a) + intVal(b), 0);
                let adminFeesTotal = api.column(15, { search: 'applied' }).data().reduce((a, b) => intVal(a) + intVal(b), 0);
                let dbFeesTotal = api.column(19, { search: 'applied' }).data().reduce((a, b) => intVal(a) + intVal(b), 0);
                let guaranteeFeesTotal = api.column(23, { search: 'applied' }).data().reduce((a, b) => intVal(a) + intVal(b), 0);

                // Count License Types
                let licenseTypeMap = {};
                api.column(2, { search: 'applied' }).data().each(function (d) {
                    if (licenseTypeMap[d]) {
                        licenseTypeMap[d]++;
                    } else {
                        licenseTypeMap[d] = 1;
                    }
                });

                let licenseTypeCountHtml = '<strong>Total Number of License Types: ' + Object.keys(licenseTypeMap).length + '</strong><br>';
                let licenseTypeDetailsHtml = '';
                for (let type in licenseTypeMap) {
                    licenseTypeDetailsHtml += `<tr><td>${type}</td><td>${licenseTypeMap[type]}</td></tr>`;
                }

                // Update totals
                $(api.column(6).footer()).html('Application Fees Grand Total: ' + formatNumber(applicationFeesTotal));
                $(api.column(11).footer()).html('License Fees Grand Total : ' + formatNumber(licenseFeesTotal));
                $(api.column(15).footer()).html('Admin Fees Grand Total:  ' + formatNumber(adminFeesTotal));
                $(api.column(19).footer()).html('DB Fees Grand Total: ' + formatNumber(dbFeesTotal));
                $(api.column(23).footer()).html('Guarantee Fees Grand Total: ' + formatNumber(guaranteeFeesTotal));

                // Show license type count summary and populate table
                $('#licenseTypeCountTotal').html(Object.keys(licenseTypeMap).length);
                $('#licenseTypeDetails tbody').html(licenseTypeDetailsHtml);
            }
        });
    });
</script>

<div style="height:10vh;"></div>
<footer th:replace="~{layout :: page_footer}"></footer>
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
